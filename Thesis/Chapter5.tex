\chapter{The total Lagrangian explicit dynamics algorithm}
\label{chap5}
\begin{shortAbstract}
In 2007, \citeauthor{Miller07} proposed the total Lagrangian explicit dynamics (TLED) algorithm, a very efficient fully non-linear formulation. We also wanted to extend the simple non-linear TLED formulation by adding the constitutive update procedure for viscoelastic models introduced by \citeauthor{Taylor07a} and an anisotropic constitutive formulation as well. A crucial advantage of this enhanced TLED algorithm is that the computations are conducted at the element level and therefore the algorithm can be easily parallelised. This work eventually yields a very efficient GPU-based non-linear, viscoelastic and anisotropic formulation for modelling solid organs in medical simulation. This chapter aims at describing the TLED algorithm in details, as well as introducing the viscoelasticity and anisotropy extensions. Their GPU implementations will be the object of the next chapter. 
\end{shortAbstract}


\section{Description of the TLED algorithm}

	\subsection{Key ideas}

The total Lagrangian explicit dynamics (TLED) algorithm was first introduced to the field of medical simulation by \cite{Miller07}. More details on this finite element method formulation may also be found in \cite{Bathe95}. It is worth noting that the finite element analysis carried out by the TLED algorithm is dynamic and fully non-linear (geometrically and materially). Let us begin by exposing the key ideas of the approach. 

The deformation of a body may be described by two different kind of description: Lagrangian or Eulerian (see section~\ref{chap2:descriptionMotion}). Because the Lagrangian description focuses its attention on the particles of the continuous body, it is usually used in solid mechanics. In the Lagrangian description, the position and physical properties of the particles are referred to a reference configuration. For the great majority of commercial finite element programs, the reference configuration is the previous configuration, that is the one at the end of the previous time step. In this case, where all variables are referred to the previous configuration, the formulation is called \emph{updated Lagrangian}. The advantage of this approach is the simplicity of the incremental strain description. The disadvantage is that all derivatives with respect to spatial coordinates must be recomputed in each time step, because the reference configuration is changing. The reason for this choice is historical, at the time of solver development the memory was expensive and caused more problems than actual speed of computations \citep{Miller07}. 

The first key idea of the TLED algorithm is to refer all variables to the undeformed configuration. This type of formulation is said to be \emph{total Lagrangian}. Because of this, the choice of the second Piola-Kirchhoff stress tensor as a measure of stress is required. The strain measure that is work-conjugate with the second Piola-Kirchhoff stress is the Green-St.Venant strain tensor. That is,  the work of stress increments on the strain increments gives an accurate expression for work \citep{Ji10}. We should note that all derivatives in the definition of the Green tensor are with respect to the initial and undeformed configuration. The decisive advantage is that all derivatives are calculated with respect to the undeformed configuration and therefore can be precomputed. This is at the cost to a more complex strain-displacement matrix due an initial displacement effect in the incremental strain \citep{Bathe95}. However, the TLED algorithm performs significantly fewer mathematical operations in each time step. 

The second crucial idea is to use the central difference method for an explicit time integration of dynamic equilibrium equations. The advantage is that the stiffness term $ \mathbf{K(\mathbf{U}).\mathbf{U}} $ of the system of equations may be computed from:
\begin{equation}
\mathbf{K(\mathbf{U}) \cdot \mathbf{U}} = \mathbf{F}(\mathbf{U}) = \sum_e \mathbf{\tilde{F}}^e,
\end{equation}
where $ \mathbf{\tilde{F}}^e $ are the global nodal force contributions due to stresses in element $ \Omega_e $. This implies that the stiffness matrix does not need to be assembled since element nodal force contributions can be computed at the element level instead, which is a decisive computational advantage. 

We will first explain how to compute element nodal forces based on the deformation gradient and a neo-Hookean constitutive model. We will then show how to use these element nodal forces to calculate the unknown displacements for each node of the model \citep{Taylor06}. 


	\subsection{Computation of element nodal forces} 
	
We adopt the notation of \citeauthor{Bathe95} with respect to indication of the relevant configuration of the body: a left superscript indicates the configuration in which a quantity occurs and, when applicable, a left subscript indicates the configuration with respect to which the quantity is measured. We note the coordinates of a point $ ^t \mathbf{x}$ at time t. 

\subsubsection*{The deformation gradient} 
As we know, a fundamental measure of deformation is the deformation gradient tensor $ _0^t \mathbf{X} $ and we recall that it may be written as:
\begin{equation}
_0^t\mathbf{X} = \pd{^t\mathbf{x}}{^0\mathbf{x}}.
\end{equation}
This tensor describes the stretches and rotations that the material fibres have undergone from time $0$ to time $t$. In order to compute the element deformation gradients, we first compute derivatives of displacements $ u_{i,j} $ with respect to global coordinates. Since we use a total Lagrangian framework, the derivatives are referred to the undeformed configuration and we have:
\begin{equation}
_0^t u_{i,j} = \pd{^t u_i}{_0 x_j} = \sum_{a=1}^N \pd{h_a}{_0 x_j} \, ^t u_{ai},
\end{equation}
where $ h_a $ is the shape function associated with node $ a $ and $ N $ the number of nodes of the element. If we define a matrix $ _0^t \mathbf{\partial u_x} $ of displacements derivatives 
\begin{equation}
_0^t\mathbf{\partial u_x} = 
	\begin{bmatrix}
	_0^t u_{1,1} &         _0^t u_{1,2}      &        _0^t u_{1,3}       \\\\
	_0^t u_{2,1} &         _0^t u_{2,2}      &        _0^t u_{2,3}       \\\\
	_0^t u_{3,1} &         _0^t u_{3,2}      &        _0^t u_{3,3}       
	\end{bmatrix}	
\end{equation}
The deformation gradient may be obtained from the displacement derivatives with:
\begin{equation}
_0^t\mathbf{X} = \leftidx{_0^t}{ \partial \mathbf{u}}{\mathbf{x}} + \mathbf{I}.
\end{equation}

\subsubsection*{The Green-Lagrange strain tensor} 
From the deformation gradient we may obtain the right Cauchy-Green deformation tensor $ _0^t \mathbf{C}  $:
\begin{equation}
_0^t\mathbf{C} = \leftidx{_0^t}{ \mathbf{X} }{^T} \, _0^t\mathbf{X},
\end{equation}
and then yields the Green-Lagrange strain tensor $ _0^t \mathbf{E}  $:
\begin{equation}
\label{chap5:E}
_0^t\mathbf{E}  = \dfrac{1}{2} (_0^t\mathbf{C} - \mathbf{I}), 
\end{equation}
where $ \mathbf{I} $ is the rank $ 2 $ identity tensor. 

		\subsubsection*{Constitutive equations and evaluation of stress}
We know that the stresses result from the deformation of the material and they may be expressed in terms of some measure of this deformation such as the strain. The constitutive equations, which depends on the material under consideration, relate the stresses to the strain. As we have seen in section \ref{chap2:elasticity}, hyperelastic materials are a general class of materials in which the constitutive relationship is expressed in the form of a strain energy density function $ _0^t W $. In such materials, the stresses are obtained by differentiating this energy density function with respect to the appropriate strain measure (that is energetically conjugate). In a total Lagrangian framework, the appropriate stress and strain measures are second Piola-Kirchhoff stress $ _0^t \mathbf{S} $ and Green-Lagrange strain $ _0^t \mathbf{E} $. Consequently, the stress may be computed from:
\begin{equation}
_0^t\mathbf{S} = \pd{ \leftidx{_0^t}{ \mathbf{W} }{} }{_0^t \mathbf{E}}.
\end{equation}

The form of the strain energy function depends on the chosen material. For the TLED algorithm we choose a neo-Hookean material already described section \ref{chap2:non-linear}. For a compressible neo-Hookean material, the strain energy density is given by:
\begin{equation}
\label{chap5:strainEnergyFunction}
_0^t W = \dfrac{1}{2} \mu (_0^t I_1 - 3 - 2 \ln ^t J) + \dfrac{1}{2} \lambda (^t J - 1)^2,
\end{equation}
where $_0^t I_1 $ is the first invariant of the right Cauchy-Green deformation tensor $ _0^t \mathbf{C} $ given by $ _0^t I_1 = tr(_0^t \mathbf{C}) $ and $ ^t J = det(_0^t \mathbf{X}) = det(_0^t \mathbf{C})^2 $ is the Jacobian.
%		
Then, using the chain rule we have:
\begin{equation}
\pd{_0^t W}{_0^t\mathbf{E}} = \pd{_0^t W}{_0^t\mathbf{C}} \pd{_0^t\mathbf{C}}{_0^t\mathbf{E}}.
\end{equation}
Noting that
\begin{equation}
\pd{_0^t\mathbf{C}}{_0^t\mathbf{E}} = 2 \quad \mbox{by \eqref{chap5:E}},
\end{equation}
Therefore, we may evaluate the stress from:
\begin{equation}
_0^t\mathbf{S}  = 2 \pd{_0^t W}{_0^t\mathbf{C}},
\end{equation}
which we can then expressed as the following:
\begin{equation}
_0^t\mathbf{S}  = 2 \left( \pd{_0^t W}{_0^t\mathbf{I_1}} \pd{_0^t\mathbf{I_1}}{_0^t\mathbf{E}} + \pd{_0^t W}{^t J} \pd{^t J}{_0^t\mathbf{E}} \right). 
\end{equation}
It may be shown that this yields:
\begin{equation}
_0^t S_{ij} = \mu (\delta_{ij} - _0^tC_{ij}^{-1}) + \lambda ^t J (^t J -1) _0^t C_{ij}^{-1}.
\end{equation}

		\subsubsection*{Element nodal forces}
For a given element at time $ t $, the global nodal force contributions $ \mathbf{\tilde{F}} $ due to stresses in the element may be computed from:
\begin{equation}
\label{chap5:elementForce}
\leftidx{^t}{ \mathbf{\tilde{F}} }{} = \int_{^0 V} \, \leftidx{_0^t}{ \mathbf{B} }{_L^t} \, \leftidx{_0^t}{ \mathbf{\hat{S}} }{} \, d\leftidx{^0}{ V }{},
\end{equation}
where $ _0^t\mathbf{\hat{S}} $ is the vector form of the second Piola-Kirchhoff stress given by:
\begin{equation}
_0^t\mathbf{\hat{S}} = \left[ _0^t S_{11} \quad _0^t S_{22} \quad _0^t S_{33} \quad _0^t S_{12} \quad _0^t S_{23} \quad _0^t S_{13} \right] ^T,
\end{equation}
$ _0^t\mathbf{B}^T_L $ is the strain-displacement matrix and $ d^0V $ is the initial (undeformed) volume of the element. The strain-displacement matrix $ \mathbf{B}_L $ relates the strains in an element to the element's nodal displacements. If an implicit analysis is performed, the strain-displacement matrix is used in the assembly of the stiffness matrix. In explicit analyses it is used to compute element nodal force contributions according to \eqref{chap5:elementForce}. In geometrically linear analyses, we assume that the displacements are infinitesimally small so that the geometry of an element does not change over time and the strain-displacement matrix is constant. Conversely, because geometrically non-linear analyses (such as carried out by the TLED algorithm) take the change of geometry of the elements into account, the strain-displacement matrix $ \mathbf{B}_L = \leftidx{_0^t}{\mathbf{B}}{_L} $ varies. However, the strain-displacement matrix at time $ t $ may be computed by transforming a linear matrix $ _0^t\mathbf{B}_{L0} $ using the deformation gradient. We begin by defining the linear matrix as:
\begin{equation}
_0^t\mathbf{B}_{L0} = \left[ _0\mathbf{B}_{L0}^{(1)} \quad _0\mathbf{B}_{L0}^{(2)} \quad \ldots \quad _0\mathbf{B}_{L0}^{(N)} \right],
\end{equation}
where $ N $ is the number of nodes per element and the submatrix $ _0\mathbf{B}_{L0}^{(a)}  $ are given by:
\begin{equation}
_0\mathbf{B}_{L0}^{(a)} =
	\begin{bmatrix}
	_0 h_{a,1} & 0 & 0 \\
	0 & _0 h_{a,2} & 0 \\
	0 & 0 & _0 h_{a,3} \\
	_0 h_{a,2} & _0 h_{a,1} & 0 \\
	0 & _0 h_{a,3} & _0 h_{a,2} \\
	_0 h_{a,3} & 0 & _0 h_{a,1}
	\end{bmatrix}
\quad a = 1, 2, \ldots, N.
\end{equation}
The subscripted comma denotes partial differentiation such as:
\begin{equation}
_0 h_{a,i} = \pd{h_a}{^0 x_i}.
\end{equation}
The full strain-displacement matrix (accounting for initial displacement effect) is then computed via
\begin{equation}
_0^t\mathbf{B}_{L}^{(a)} = \leftidx{_0^t}{ \mathbf{B} }{_{L0}^{(a)}} \, \leftidx{_0^t}{ \mathbf{X} }{^T}.
\end{equation} 
We note that the linear strain-displacement matrix is composed of derivatives of shape functions with respect to the original undeformed coordinates of the body. These derivatives are therefore constant and may be precomputed, affording the total Lagrangian formulation a significant computational advantage. 

	\subsection{Computation of node displacements} \label{chap5:computeNodalDisp}
We recall that the dynamic system of equations describing a deformable solid is the following (see section \ref{chap3:dynamic2}):
\begin{equation}
\label{chap5:eqDynamic}
\mathbf{M} \mathbf{\ddot U} + \mathbf{D} \mathbf{ \dot U} + \mathbf{K}(\mathbf{U}) \cdot \mathbf{U} = \mathbf{R}.
\end{equation}		
where $ \mathbf{M} $ is a constant mass matrix, $\mathbf{D}$ is a constant damping matrix, $ \mathbf{K}^e(\mathbf{U}^e) $ is the stiffness matrix, which is a function of nodal displacements $\mathbf{U}$, and $\mathbf{R}$ are externally applied loads. And we seek the unknown displacements $ \mathbf{U} $.
	
		\subsubsection*{Mass and damping matrices}					
The mass matrix for the system may be computed by summing contributions from individual elements:
\begin{equation}
\mathbf{M} = \sum_e \mathbf{M}^e,
\end{equation}		
where $ \mathbf{M}^e $ is the mass contribution from element $ \Omega_e $ given by:
\begin{equation}
\mathbf{M}^e = \int_{^0 V_e} \rho_e \mathbf{H}^T \mathbf{H} \, d^0 V.
\end{equation}
Following the total Lagrangian framework, we observe that the expression is integrated over the undeformed volume and the mass density $ \rho_e $ of the undeformed configuration is also used. We then diagonalise the mass matrix by applying the technique of mass lumping as explained in section \ref{chap3:wordOnMatrices}. Therefore, the mass matrix may be built by directly computing the mass of each element and assigning an equal proportion of this to each of the element's nodes. In other words, if the mass of element $ \Omega_e $ is $ m_e $ then for every node $ a $ which is attached to this element, the $ a^{th} $ diagonal component $ M_{aa} $ of the global mass matrix will receive a contribution of $ m_e/N $ where $ N $ is the number of nodes per element. The complete matrix is compiled by summing contributions from all elements. 

We also employ a Rayleigh damping from which we only consider the mass-proportional component to obtain a diagonal damping matrix. Consequently, $ \mathbf{D} $ is computed from:
\begin{equation}
\mathbf{D} = \alpha \mathbf{M}.
\end{equation}


		\subsubsection*{Gathering of nodal forces}
As stated early in this chapter, the stiffness matrix of \eqref{chap5:eqDynamic} may be obtained from
\begin{equation}
\mathbf{K(\mathbf{U}).\mathbf{U}} = \mathbf{F}(\mathbf{U}) = \sum_e \mathbf{\tilde{F}}^e.
\end{equation}
The previous section detailed how to calculate element nodal forces $ \mathbf{\tilde{F}}^e $. For each node we can now add the element force contributions up from all elements attached to this node. Gathering those nodal force contributions allows us to compute the stiffness term of the equilibrium equations $ ^t\mathbf{F} $. Therefore, \eqref{chap5:eqDynamic} may be re-written as the following:
\begin{equation}
\label{chap5:eqDynamic2}
\mathbf{M} \leftidx{^t}{ \mathbf{\mathbf{\ddot U}} }{} + \mathbf{D} \leftidx{^t}{ \mathbf{\mathbf{\dot U}} }{} + \leftidx{^t}{\mathbf{F}}{} = \leftidx{^t}{\mathbf{R}}{}.
\end{equation}
		
		\subsubsection*{Explicit time integration}
The remaining step is the time integration of \eqref{chap5:eqDynamic2} to find out the expression of $ ^t\mathbf{U} $. For this, we employ the explicit central difference method described page \pageref{chap3:centralDifferenceMethod}. We assume that all displacements, velocities and accelerations for the current time step is known and we seek a formula for computing displacements at time $ t+\Delta t $. Let us remind \eqref{chap3:relationCDM} for convenience:
\begin{equation}
\left( \dfrac{\mathbf{M}}{(\Delta t)^2} + \dfrac{\mathbf{D}}{2 \Delta t} \right) \mathbf{U}^{t+\Delta t} = \mathbf{R}^t - \mathbf{F}^t + \dfrac{2 \mathbf{M}}{(\Delta t)^2} \mathbf{U}^t + \left( \dfrac{\mathbf{D}}{2 \Delta t} - \dfrac{\mathbf{M}}{(\Delta t)^2} \right) \mathbf{U}^{t-\Delta t}.
\end{equation}
By using diagonalised mass and damping matrices, this expression may be rearranged to give a formula for updating displacements component-wise:
\begin{equation}
\label{chap5:CDMcomponents}
\leftidx{^{t+\Delta t}}{ \mathbf{U} }{_i} = \dfrac{\leftidx{^t}{R}{_i} - \leftidx{^t}{F}{_i} + \frac{2 M_{ii}}{\Delta t^2} \leftidx{^t}{U}{_i}  + \left( \frac{D_{ii}}{2 \Delta t} -\frac{M_{ii}}{\Delta t^2} \right) \leftidx{^{t-\Delta t}}{U}{_i} }{ \frac{D_{ii}}{2 \Delta t} +\frac{M_{ii}}{\Delta t^2} }
\end{equation}
Let us define the following vectors:
\begin{align}
A_i &= \dfrac{1}{ \frac{D_{ii}}{2 \Delta t} +\frac{M_{ii}}{\Delta t^2} } \\
B_i &= \dfrac{ \frac{2 M_{ii}}{\Delta t^2} }{ \frac{D_{ii}}{2 \Delta t} +\frac{M_{ii}}{\Delta t^2} } = \dfrac{2 M_{ii}}{\Delta t^2} A_i \\
C_i &= \dfrac{ \frac{D_{ii}}{2 \Delta t} -\frac{M_{ii}}{\Delta t^2} }{ \frac{D_{ii}}{2 \Delta t} +\frac{M_{ii}}{\Delta t^2} } = \dfrac{D_{ii}}{2\Delta t} A_i - \dfrac{B_i}{2},
\end{align}
Equation \eqref{chap5:CDMcomponents} may be rewritten as:
\begin{equation}
\leftidx{^{t+\Delta t}}{ \mathbf{U} }{_i} = A_i \, (\leftidx{^t}{R}{_i} - \leftidx{^t}{F}{_i}) + B_i \, \leftidx{^t}{U}{_i} + C_i \, \leftidx{^{t-\Delta t}}{U}{_i}.
\end{equation}
It is worth noting that the coefficient vectors $ \mathbf{A} $, $ \mathbf{B} $ and $ \mathbf{C} $ can be precomputed. 

\bigskip

Of crucial importance in explicit analyses is the restriction on time step sizes imposed by stability constraints\label{chap5:discussionTimestep}. As mentioned, the central difference method is only stable if $ \Delta t <  \Delta t_{cr} $. Essentially, stability requires that the time step be not larger than the time required for a dilatational wave to propagate through the smallest element. In linear analyses this translates into the following formula for $ \Delta t_{cr}$:
\begin{equation}
\label{chap5:criticalTimestep}
\Delta t_{cr} = \dfrac{L_e}{c},
\end{equation}
where $ L_e $ is the smallest characteristic element length (roughly interpreted as the smallest edge length) in the assembly, and $c$ is the dilatational wave speed of the material, given by
\begin{equation}
\label{chap5:waveSpeed}
c = \sqrt{\dfrac{E (1 - \nu)}{\rho (1+\nu)(1-2\nu)}},
\end{equation}
where $E$ is Young's modulus and $\nu$ is Poisson's ratio. If non-linear analyses (either geometric or material) are conducted, a somewhat smaller time step must be employed since $c$ will change with deformation, and in particular will generally increase. Additionally, the presence of damping necessitates a further decrease in the limit. Nonetheless, \eqref{chap5:waveSpeed} may be used to estimate $ \Delta t_{cr}$. 

Some important observations arise from \eqref{chap5:criticalTimestep} and \eqref{chap5:waveSpeed}. Firstly, since the stiffness of soft tissues is very much smaller than that of common engineering materials ($E \approx 3 \times 10^3\, $Pa for brain tissue versus $\approx 2 \times 10^{11}\, $Pa for steel), the allowable time step is much larger for analysis of the former. This is a key reason for the expediency of explicit time integration for analysis of soft tissues. Secondly, soft tissues are generally considered to be incompressible, leading to $\nu \approx 0.49$ commonly being employed. However, if this value can be relaxed even further, significant increases in $ \Delta t_{cr}$ are possible. As an example, for a given $ L_e $ a material with $E = 3\,000\, $Pa and $\nu = 0.45$ allows a time step of more than double that of a material with $\nu = 0.49$. Of course, lowering the Poisson's ratio introduces inaccuracies, but for some applications (interactive medical simulation for instance) it may be that this is acceptable. Finally, it must be highlighted that $ \Delta t_{cr}$ is proportional to $ L_e $. If the element size is decreased (by using a finer mesh, or by analysing very small objects), inexorably $ \Delta t_{cr}$ is also reduced. 



\section{Anisotropic and viscoelastic constitutive equations}

	\subsection{An extension to the TLED algorithm}	
An attractive feature of explicit analyses is the relative ease with which arbitrarily complicated constitutive models may be incorporated. This arises from the fact that element stresses are computed directly from strains in the course of the procedure. Additionally, there is no requirement for computation of tangent matrices as in implicit or quasi-static procedures, since there is no involvement of Newtonian iterations. While the developments above incorporated a hyperelastic constitutive formulation (neo-Hookean), thus accommodating non-linearity of the strain-related tissue stress response, the formulation was intentionally simple nonetheless since the focus was on validation of the computational framework. Two further key features of the response of most biological tissues are time- (and rate-)dependence and anisotropy \citep{Fung93}. 

Time-dependence manifests itself in many aspects of the mechanical response. Soft tissues under constant load generally exhibit creep, while those under constant deformation exhibit stress relaxation. Additionally, most tissues appear stiffer at higher loading velocities. In particular, so-called visco-hyperelastic models based on strain energy functions with time-dependent parameters have been shown to reproduce both the time-dependent and large strain aspects of the response \citep{Miller97,Miller00,Nava08}. 

Anisotropic mechanical response may arise, for example, from the presence of a highly organised micro-structure such as those of connective tissues. These are predominantly composed of collagen or elastin fibres embedded in an amorphous matrix \citep{Fung93}, and may be considered as fibre reinforced composites in some cases. Alternatively, the presence of vasculature and other functional components means even non-load bearing organs may exhibit directional dependence \citep{Picinbono01,Prange02}. Whereas isotropic constitutive models may be formulated in terms of the usual principal strain invariants (as used in \eqref{chap5:strainEnergyFunction} for a neo-Hookean material), directional dependence requires inclusion of so-called pseudo-invariants of strain and material direction. 

In order to model such soft-tissue features with the explicit TLED formulation without significant performance penalties, an efficient constitutive update procedure involving time integration of the relevant hereditary equations is required. We address this problem by presenting a procedure similar to that developed by \cite{Poon98} for analysis of anisotropic linear viscoelastic models. This was also adapted by \cite{Taylor07c} for solution of their fibre composite-based micro-structural model. In these cases the rate independent responses were based on linear elasticity, rather than a hyperelastic formulation suitable for large deformations. In the present work we begin with a class of anisotropic visco-hyperelastic models, and develop a constitutive update procedure for explicit analyses based on these. 
		
	\subsection{Visco-hyperelasticity}
Large recoverable deformations and the time- and rate-dependence of the mechanical response of soft-tissues have led to the formulation of visco-hyperelastic constitutive models in which an underlying hyperelastic formulation is augmented by time dependent (viscoelastic) material parameters. Models of this type are well known in the continuum mechanics community, and provide a kinematically consistent basis for modelling non-linear materials at large deformations.
	
For such materials the constitutive response is defined in terms of a time-dependent Helmholtz free energy (strain energy) function $ \hat{\Psi} $, expressed in the form of a convolution integral:
\begin{equation}
\hat{\Psi} (\Psi ,t) = \int_0^t \alpha (t-s) \pd{\Psi}{s} ds,
\end{equation}
where $ t $ is time and $ \Psi $ is the underlying hyperelastic strain energy function. The relaxation functions $ \alpha (t) $ commonly assume the form of a Prony series:
\begin{equation}
\label{chap5:PronySeries}
\alpha (t) = \alpha_{\infty} + \sum_{i=1}^N \alpha_i e^{-t/\tau_i},
\end{equation}
where $ \alpha_{\infty} $, $ \alpha_i $ and $ \tau_i $ are positive real constants. Such forms for the relaxation functions have a physical interpretation, namely that of a generalised Maxwell model \citep{Holzapfel96}. If we impose the condition
\begin{equation}
\left( \alpha_{\infty} + \sum_{i=1}^N \alpha_i \right) = 1
\end{equation}
we may rewrite\eqref{chap5:PronySeries} as
\begin{equation}
\label{chap5:PronySeries2}
\alpha (t) = 1 - \sum_{i=1}^N \alpha_i (1-e^{-t/\tau_i}),
\end{equation}
which will be of use in subsequent sections. 

\bigskip

\noindent The required stress $ \mathbf{S} $ may be obtained via differentiation with respect to strain:
\begin{equation}
\label{chap5:stress}
\mathbf{S} = 2 \pd{\hat{\Psi}(\Psi , t)}{\mathbf{C}} = \int_0^t \alpha (t-s) \left( 2 \pd{}{s} \pd{\Psi}{\mathbf{C}} \right) ds = \int_0^t \alpha (t-s) \pd{\boldsymbol \Phi}{s} ds,
\end{equation}
where $ \mathbf{C} $ is the right Cauchy-Green deformation tensor, and we have introduced $ \boldsymbol \Phi \, {\buildrel\mathrm	def\over=} \, 2 \partial \Psi / \partial \mathbf{C} $ as the instantaneous hyperelastic stress response.

\bigskip

Models of this form have been presented by Miller and co-workers for analysis of brain tissue \citep{Miller97,Miller02} and of liver and kidney \citep{Miller00}. They were shown to model the tissue responses to compressive (and in the case of brain, tensile) loading at strain rates varying over two orders of magnitude very well. We next consider evaluation of the hyperelastic stress response $ \boldsymbol \Phi $.

	\subsection{Hyperelastic response}
We firstly consider the case of isotropic materials, from which anisotropic formulations follow. We then consider the standard cases of transverse isotropy and orthotropy, which may be viewed as arising from, for example, the presence of mutually orthogonal reinforcing fibre phases. In considering these cases we encompass constitutive equations which have been proposed for a wide variety of biological tissues.
	
	\subsubsection*{Isotropic materials}
For isotropic materials the strain energy is a function of strain only, hence $ \Psi = \Psi (\mathbf{C}) $. In this work we consider strain energy functions with separated isochoric (volume preserving) and volumetric components \citep{Holzapfel00}:
\begin{equation}
\label{chap5:IstrainEnergy}
\Psi (\mathbf{C}) = \Psi ^{iso} (\mathbf{\bar{C}}) + \Psi ^{vol} (J) = \Psi ^{iso} (\bar{I}_1, \bar{I}_2) + \Psi ^{vol} (J),
\end{equation}
where $ J $ is the Jacobian determinant, $ \mathbf{\bar{C}} = J^{2/3} \mathbf{C} $ is the modified right Cauchy-Green deformation, and $ \bar{I}_1 = tr \mathbf{\bar{C}} $ and $ \bar{I}_2 = \left[ (tr \mathbf{\bar{C}})^2 - tr (\mathbf{\bar{C}}^2) \right] / 2 $ are invariants of $ \mathbf{\bar{C}} $. The hyperelastic stress $ \boldsymbol \Phi $ then also consists of isochoric and volumetric components: 
\begin{equation}
\boldsymbol \Phi = \boldsymbol \Phi^{iso} +\boldsymbol \Phi^{vol} ,
\end{equation}
where
\begin{align}
\boldsymbol \Phi^{vol} &= 2 \pd{\Psi^{vol}(J)}{\mathbf{C}} = J \dfrac{d\Psi^{vol}(J)}{dJ} \mathbf{C}^{-1}, \label{chap5:Phi_vol} \\
\intertext{and}
\boldsymbol \Phi^{iso} &= 2 \pd{\Psi^{iso}(\mathbf{\bar{C}})}{\mathbf{C}} = J^{-2/3} \mbox{Dev}  \bar{\boldsymbol \Phi}, \label{chap5:Phi_iso}
\end{align}
where Dev$(\bullet) = (\bullet) - (1/3)[(\bullet) : \mathbf{C}] \mathbf{C}^{-1}$ is the referential configuration deviatoric operator for a second order tensor \citep{Holzapfel00}, and
\begin{equation}
\label{chap5:PhiBar}
\bar{\boldsymbol \Phi} = 2 \pd{\Psi^{iso}(\mathbf{\bar{C}})}{\mathbf{\bar{C}}} = \bar{\gamma}_1 \mathbf{I} + \bar{\gamma}_2 \mathbf{\bar{C}},
\end{equation}
with 
\begin{equation}
\bar{\gamma}_1 = 2 \left( \pd{\Psi^{iso}}{\bar{I}_1} + \bar{I}_1 \pd{\Psi^{iso}}{\bar{I}_2} \right) \quad \mbox{and} \quad \bar{\gamma}_2 = -2 \pd{\Psi^{iso}}{\bar{I}_2}.
\end{equation}

	
	\subsubsection*{Transversely isotropic materials}
Transversely isotropic materials are characterised by a single preferred direction $\mathbf{a}_0$ in the reference configuration; the mechanical response is isotropic in the plane orthogonal to this direction. The strain energy is then a function of both $  \mathbf{C} $ and a structure tensor $\mathbf{A}_0 \, {\buildrel\mathrm	def\over=} \,  \mathbf{a}_0 \otimes \mathbf{a}_0$, where $\otimes$ denotes a tensor product. Analogous to the isotropic case, we consider strain energy functions of the form	
\begin{equation}
\label{chap5:TIstrainEnergy}
\Psi (\mathbf{C}, \mathbf{A}_0) = \Psi^{iso}(\bar{I}_1, \bar{I}_2, \bar{I}_4, \bar{I}_5) + \Psi^{vol}(J),
\end{equation}
where $ \bar{I}_4 = \mathbf{a}_0 \cdot \mathbf{\bar{C}} \mathbf{a}_0$ and $ \bar{I}_5 = \mathbf{a}_0 \cdot \mathbf{\bar{C}}^2 \mathbf{a}_0 $ are pseudo-invariants of $ \mathbf{\bar{C}} $ and $ \mathbf{A}_0 $. 

\bigskip

\noindent As can be seen transversely isotropic strain energy functions \eqref{chap5:TIstrainEnergy} differ from isotropic ones \eqref{chap5:IstrainEnergy} only in the form of the isochoric term. Therefore the volumetric and isochoric stresses $ \boldsymbol \Phi^{vol} $ and $ \boldsymbol \Phi^{iso} $ remain as in \eqref{chap5:Phi_vol} and \eqref{chap5:Phi_iso} but with $\bar{\boldsymbol \Phi} $ given by
\begin{equation}
\label{chap5:PhiBarTI}
\bar{\boldsymbol \Phi} = \bar{\gamma}_1 \mathbf{I} + \bar{\gamma}_2 \mathbf{\bar{C}} + \bar{\gamma}_4 \mathbf{A}_0 + \bar{\gamma}_5 ( \mathbf{a}_0 \otimes \mathbf{\bar{C}} \mathbf{a}_0 +  \mathbf{\bar{C}} \mathbf{a}_0 \otimes \mathbf{a}_0 ),
\end{equation}
with 
\begin{equation}
\bar{\gamma}_a = 2 \pd{\Psi^{iso}}{\bar{I}_a}, \quad a = 4, 5.
\end{equation}

	
	\subsubsection*{Orthotropic materials}
Orthotropic materials are characterised by three mutually orthogonal preferred directions, which we identify with unit vectors $\mathbf{a}_0$ and $\mathbf{b}_0$ (and corresponding structure tensors $\mathbf{A}_0$ and $\mathbf{B}_0$), in the reference configuration. We need specify only two vectors, since the direction orthogonal to these naturally emerges as a preferred direction also. Orthotropic strain energy functions are then of the form
\begin{equation}
\Psi (\mathbf{C}, \mathbf{A}_0, \mathbf{B}_0) = \Psi^{iso}(\bar{I}_1, \bar{I}_2, \bar{I}_4, \bar{I}_5, \bar{I}_6, \bar{I}_7) + \Psi^{vol}(J),
\end{equation}
where $ \bar{I}_6 = \mathbf{b}_0 \cdot \mathbf{\bar{C}} \mathbf{b}_0 $ and $ \bar{I}_7 =  \mathbf{b}_0 \cdot \mathbf{\bar{C}}^2 \mathbf{b}_0 $ are pseudo-invariants of $ \mathbf{\bar{C}} $ and $ \mathbf{B}_0 $. In a similar manner to the transversely isotropic case we obtain $ \boldsymbol \Phi^{vol} $ and $ \boldsymbol \Phi^{iso} $ from \eqref{chap5:Phi_vol} and \eqref{chap5:Phi_iso}, with $\bar{\boldsymbol \Phi} $ now given by
\begin{equation}
\label{chap5:PhiBarOrtho}
\begin{split}
\bar{\boldsymbol \Phi} = \bar{\gamma}_1 \mathbf{I} + \bar{\gamma}_2 \mathbf{\bar{C}} + \bar{\gamma}_4 \mathbf{A}_0 + \bar{\gamma}_5 ( \mathbf{a}_0 \otimes \mathbf{\bar{C}} \mathbf{a}_0 +  \mathbf{\bar{C}} \mathbf{a}_0 \otimes \mathbf{a}_0 ) \\
+ \bar{\gamma}_6 \mathbf{B}_0 + \bar{\gamma}_7 ( \mathbf{b}_0 \otimes \mathbf{\bar{C}} \mathbf{b}_0 +  \mathbf{\bar{C}} \mathbf{b}_0 \otimes \mathbf{b}_0 )
\end{split}
\end{equation}
where
\begin{equation}
\bar{\gamma}_a = 2 \pd{\Psi^{iso}}{\bar{I}_a}, \quad a = 6, 7.
\end{equation}
	
	\subsection{Recapitulation}	
For a visco-hyperelastic material stress may be obtained from \eqref{chap5:stress}. This form is general in the sense that any underlying hyperelastic response may be used, including the anisotropic formulations described \eqref{chap5:IstrainEnergy}, supplemented with \eqref{chap5:Phi_vol}, \eqref{chap5:Phi_iso}, and \eqref{chap5:PhiBar} is the general form of an isotropic hyperelastic stress response, defined in terms of invariants. Transversely isotropic or orthotropic models may be produced by substituting \eqref{chap5:PhiBar} for \eqref{chap5:PhiBarTI} or \eqref{chap5:PhiBarOrtho}, respectively. The specification of particular forms of  $ \Psi^{vol} $ and $ \Psi^{iso} $ would be motivated by the particular tissue/material under analysis, and may stem from phenomenological or micro-structural considerations. Finally we note that for separated isochoric and volumetric hyperelastic functions as used here, viscoelastic terms may be applied to either or both independently. 
	
	
\section{Constitutive update procedure for explicit analyses}

Use of the above visco-hyperelastic models within the TLED algorithm (or any other explicit dynamic finite element procedure) requires a constitutive update scheme involving time integration of \eqref{chap5:stress}. 

	\subsection{Stress update equations}	
We proceed by restating \eqref{chap5:stress} and using \eqref{chap5:PronySeries2}:	
\begin{equation}
\mathbf{S} = \int_0^t \left[ 1 - \sum_{i=1}^N \alpha_i (1-e^{(s-t)/\tau_i}) \right] \pd{\boldsymbol \Phi}{s} ds .
\end{equation}
This may be separated into rate-dependent and -independent terms as
\begin{equation}
\mathbf{S} = \boldsymbol \Phi - \sum_{i=1}^N \boldsymbol \Upsilon_i,
\end{equation}
where
\begin{equation}
\label{chap5:Upsilon}
\boldsymbol \Upsilon_i = \int_0^t \alpha_i \left( 1-e^{(s-t)/\tau_i} \right) \pd{\boldsymbol \Phi}{s} ds, \quad i \in [1, N]
\end{equation}
are rate-dependent terms associated with each term in the Prony series. 

\bigskip

\noindent In an incremental analysis we require the stress at the current increment given the deformation state and history of the material. Adding superscripts to indicate time increments the stress may be updated using
\begin{equation}
\label{chap5:updateStress}
\mathbf{S}^n = \boldsymbol \Phi^n - \sum_{i=1}^N \boldsymbol \Upsilon_i^n. 
\end{equation}
The instantaneous terms $ \boldsymbol \Phi^n $ may be computed directly from the (known) current deformation $ \mathbf{C}^n $. The main difficulty is then computation of the incremental rate-dependent terms $ \boldsymbol \Upsilon_i^n $. Following \cite{Poon98}, our strategy is to maintain each $ \boldsymbol \Upsilon_i^n $ as a separate state variable to be updated at each increment also.

	\subsection{State variable update equations}	
Our approach is to convert the integral equation \eqref{chap5:Upsilon} into a rate form which may then be numerically integrated to produce an incremental update formula for $ \boldsymbol \Upsilon_i^n $. We note that \eqref{chap5:Upsilon} is of the form
\begin{equation}
y(t) = \int_0^t f(t,s) ds.
\end{equation}
\cite{Poon98} provide the following formula for differentiating such equations with respect to $ t $:
\begin{equation}
\dot y = f(t, t) + \int_0^t \dot f(t,s) ds.
\end{equation}
Applying this formula to \eqref{chap5:Upsilon} we obtain
\begin{align}
f(t, t) &= \alpha_i \left( 1-e^{(t-t)/\tau_i} \right) \pd{\boldsymbol \Phi}{s} \notag \\
&= 0 \\
\intertext{and}
\dot f(t, s) &= \dfrac{d}{dt} \left[ \alpha_i \left( 1-e^{(s-t)/\tau_i} \right) \pd{\boldsymbol \Phi}{s} \right] \notag \\
&= \alpha_i e^{(s-t)/\tau_i} \pd{\boldsymbol \Phi}{s} \dfrac{1}{\tau_i},
\end{align}
leading to the required rate form for $ \boldsymbol \Upsilon_i $:
\begin{align}
\dot{\boldsymbol \Upsilon_i}  &= \dfrac{1}{\tau_i} \int_0^t \alpha_i e^{(s-t)/\tau_i} \pd{\boldsymbol \Phi}{s} ds \notag \\
&= \dfrac{1}{\tau_i} (\alpha_i \boldsymbol \Phi - \boldsymbol \Upsilon_i). \label{chap5:UpsilonRate}
\end{align}

\bigskip

\noindent Equation \eqref{chap5:UpsilonRate} may be integrated using a convenient numerical method. In particular the unconditionally stable backward Euler method suggested by \cite{Poon98} yields the following formula for $ \boldsymbol \Upsilon_i^n $:
\begin{align}
\boldsymbol \Upsilon_i^n &= \left( \dfrac{\alpha_i \boldsymbol \Phi^n}{\tau_i} + \dfrac{\boldsymbol \Upsilon_i^{n-1}}{\Delta t} \right) / \left(\dfrac{1}{\Delta t} + \dfrac{1}{\tau_i} \right) \notag \\
&= A \boldsymbol \Phi^n + B \boldsymbol \Upsilon_i^{n-1}, \label{chap5:updateStateVar}
\end{align}
where $ \Delta t $ is the time step size, and $ A = \Delta t \alpha_i / (\Delta t + \tau_i) $ and $ B = \tau_i / (\Delta t + \tau_i) $ are constant coefficients. 
	
	\subsection{Summary}	
The constitutive update procedure consists of
\begin{enumerate}
\item Updating state variables (one for each Prony term) via \eqref{chap5:updateStateVar}.
\item Updating stresses via \eqref{chap5:updateStress}.
\end{enumerate}
Assuming a constant time step size $ \Delta t $, the coefficients $ A $ and $ B $ may be precomputed. 


\section{Conclusion}

The main advantage of the TLED is that the average number of floating-point operations per element per time step is $35\, $\% lower than for the similar implementation of the algorithm based on updated Lagrangian formulation \citep{Miller07}. Coupled with the use of an explicit integration scheme that eliminates the need for an iterative equation solving, the work of \cite{Miller07} constituted a step towards the simulation of entire organs in real-time. However, explicit analyses impose a critical time step for the simulation to remain stable (see detailed discussion about the critical time step in section~\ref{chap6:criticalTimestep} page~\pageref{chap6:criticalTimestep}). 

A constitutive update procedure for anisotropic and visco-hyperelastic materials has also been presented. The procedure allows the incorporation of these elaborate mechanical properties with only a small additional computational cost. 

A crucial benefit of this enhanced TLED algorithm is that the computations are conducted at the element level and therefore the algorithm can be easily parallelised. Hence, in 2007 \citeauthor{Taylor07b} re-formulated the TLED algorithm to propose the first GPU implementation of a fully non-linear finite element method. However, restrictions due to using a graphics-based API necessitated re-formulation of the force summation in their implementation. With the release by NVIDIA of a new graphics card architecture along with a new and more flexible non-graphics API specially designed for general-purpose GPU, we decided to investigate the re-implementation of the TLED for this new architecture with the idea of a more straightforward and efficient implementation in mind. We also improved the model by including the anisotropic and viscoelastic features in the GPU implementation. This implementation is detailed in the following chapter. 

